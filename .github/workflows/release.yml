name: Release
run-name: "SlipStream ${{ github.ref_name || format('v{0}', inputs.version) }}"

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  GO_VERSION: '1.25'
  BUN_VERSION: 'latest'

jobs:
  # ===========================================
  # Stage 1: Build frontend + resolve version
  # ===========================================
  build-frontend:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create tag and release for dispatch
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG="${{ steps.version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping creation"
          else
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi
          if ! gh release view "$TAG" &>/dev/null; then
            gh release create "$TAG" --title "SlipStream $TAG" --notes ""
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install frontend dependencies
        run: bun install --cwd web

      - name: Build frontend
        run: bun run --cwd web build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist
          retention-days: 1

  # ===========================================
  # Stage 2: Platform builds (parallel, upload to release on completion)
  # ===========================================

  # Windows: Native build + WiX v5 MSI installer + portable ZIP
  build-windows:
    needs: build-frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Cache go-winres
        id: cache-gowinres
        uses: actions/cache@v4
        with:
          path: ~/go/bin/go-winres.exe
          key: go-winres-windows-1

      - name: Embed Windows resources
        shell: bash
        run: |
          if ! command -v go-winres &> /dev/null; then
            go install github.com/tc-hib/go-winres@latest
          fi
          go-winres make --in scripts/windows/winres.json --out cmd/slipstream/rsrc

      - name: Build Windows binary
        shell: bash
        env:
          CGO_ENABLED: 1
          GOOS: windows
          GOARCH: amd64
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          VERSION="${{ needs.build-frontend.outputs.version }}"
          mkdir -p dist/slipstream_windows_amd64
          go build -ldflags "-s -w -H windowsgui \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${VERSION}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_windows_amd64/slipstream.exe ./cmd/slipstream

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ needs.build-frontend.outputs.version }}"
          Compress-Archive -Path dist/slipstream_windows_amd64/* -DestinationPath "dist/slipstream_${version}_windows_amd64.zip"

      - name: Cache WiX toolset
        id: cache-wix
        uses: actions/cache@v4
        with:
          path: |
            ~/.dotnet/tools
            ~/.wix
          key: wix-windows-5.0.2

      - name: Install WiX v5
        if: steps.cache-wix.outputs.cache-hit != 'true'
        run: |
          dotnet tool install --global wix --version 5.0.2
          wix extension add --global WixToolset.UI.wixext/5.0.2
          wix extension add --global WixToolset.Util.wixext/5.0.2

      - name: Create MSI installer
        shell: bash
        run: |
          VERSION="${{ needs.build-frontend.outputs.version }}"
          wix build scripts/windows/installer.wxs \
            -o "dist/slipstream_${VERSION}_windows_amd64.msi" \
            -d VERSION=${VERSION} \
            -bindpath dist=dist/slipstream_windows_amd64 \
            -ext WixToolset.UI.wixext \
            -ext WixToolset.Util.wixext

      - name: Upload to GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ needs.build-frontend.outputs.tag }}" \
            dist/*.zip dist/*.msi --clobber

  # macOS Intel (amd64) - native build with CGO for menu bar
  build-macos-amd64:
    needs: build-frontend
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Build macOS binary (amd64)
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: amd64
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          VERSION="${{ needs.build-frontend.outputs.version }}"
          mkdir -p dist/slipstream_darwin_amd64
          go build -ldflags "-s -w \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${VERSION}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_darwin_amd64/slipstream ./cmd/slipstream

      - name: Create DMG
        run: |
          chmod +x scripts/macos/create-dmg.sh
          ./scripts/macos/create-dmg.sh ${{ needs.build-frontend.outputs.version }} amd64

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ needs.build-frontend.outputs.tag }}" \
            dist/*.dmg --clobber

  # macOS Apple Silicon (arm64) - native build with CGO for menu bar
  build-macos-arm64:
    needs: build-frontend
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Build macOS binary (arm64)
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: arm64
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          VERSION="${{ needs.build-frontend.outputs.version }}"
          mkdir -p dist/slipstream_darwin_arm64
          go build -ldflags "-s -w \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${VERSION}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_darwin_arm64/slipstream ./cmd/slipstream

      - name: Create DMG
        run: |
          chmod +x scripts/macos/create-dmg.sh
          ./scripts/macos/create-dmg.sh ${{ needs.build-frontend.outputs.version }} arm64

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ needs.build-frontend.outputs.tag }}" \
            dist/*.dmg --clobber

  # Linux: Build binaries + deb/rpm packages + AppImage
  build-linux:
    needs: build-frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Build Linux binaries
        env:
          CGO_ENABLED: 0
          GOOS: linux
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          VERSION="${{ needs.build-frontend.outputs.version }}"
          mkdir -p dist/slipstream_linux_amd64 dist/slipstream_linux_arm64
          LDFLAGS="-s -w \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${VERSION}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'"

          GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/slipstream_linux_amd64/slipstream ./cmd/slipstream &
          GOARCH=arm64 go build -ldflags "$LDFLAGS" -o dist/slipstream_linux_arm64/slipstream ./cmd/slipstream &
          GOARCH=amd64 go build -ldflags "-s -w" -o dist/slipstream_linux_amd64/slipstream-stub ./cmd/stub &
          GOARCH=arm64 go build -ldflags "-s -w" -o dist/slipstream_linux_arm64/slipstream-stub ./cmd/stub &
          wait

      - name: Create portable tarballs
        run: |
          VERSION=${{ needs.build-frontend.outputs.version }}
          # Create tarballs with just the binary (for auto-updates)
          tar -czvf "dist/slipstream_${VERSION}_linux_amd64.tar.gz" -C dist/slipstream_linux_amd64 slipstream
          tar -czvf "dist/slipstream_${VERSION}_linux_arm64.tar.gz" -C dist/slipstream_linux_arm64 slipstream

      - name: Cache nfpm
        id: cache-nfpm
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/nfpm
          key: nfpm-linux-2.44.1

      - name: Install nfpm
        if: steps.cache-nfpm.outputs.cache-hit != 'true'
        run: |
          NFPM_VERSION="2.44.1"
          curl -sL "https://github.com/goreleaser/nfpm/releases/download/v${NFPM_VERSION}/nfpm_${NFPM_VERSION}_Linux_x86_64.tar.gz" -o /tmp/nfpm.tar.gz
          tar -xzf /tmp/nfpm.tar.gz -C /tmp
          sudo mv /tmp/nfpm /usr/local/bin/
          nfpm --version

      - name: Create deb/rpm packages
        run: |
          VERSION=${{ needs.build-frontend.outputs.version }}

          # Create nfpm config for amd64
          # Uses stub launcher pattern: stub in /usr/bin, real binary in /usr/share
          # This enables auto-updates without sudo
          cat > nfpm-amd64.yaml << EOF
          name: slipstream
          arch: amd64
          platform: linux
          version: ${VERSION}
          maintainer: SlipStream <noreply@slipstream.local>
          description: Unified media management system
          vendor: SlipStream
          homepage: https://github.com/jatassi/SlipStream
          license: MIT
          contents:
            - src: dist/slipstream_linux_amd64/slipstream-stub
              dst: /usr/bin/slipstream
            - src: dist/slipstream_linux_amd64/slipstream
              dst: /usr/share/slipstream/slipstream
            - src: scripts/linux/slipstream.service
              dst: /usr/share/doc/slipstream/slipstream.service
              type: config
            - src: scripts/linux/slipstream.desktop
              dst: /usr/share/applications/slipstream.desktop
              type: config
          scripts:
            postinstall: scripts/linux/postinstall.sh
          EOF

          # Create nfpm config for arm64
          cat > nfpm-arm64.yaml << EOF
          name: slipstream
          arch: arm64
          platform: linux
          version: ${VERSION}
          maintainer: SlipStream <noreply@slipstream.local>
          description: Unified media management system
          vendor: SlipStream
          homepage: https://github.com/jatassi/SlipStream
          license: MIT
          contents:
            - src: dist/slipstream_linux_arm64/slipstream-stub
              dst: /usr/bin/slipstream
            - src: dist/slipstream_linux_arm64/slipstream
              dst: /usr/share/slipstream/slipstream
            - src: scripts/linux/slipstream.service
              dst: /usr/share/doc/slipstream/slipstream.service
              type: config
            - src: scripts/linux/slipstream.desktop
              dst: /usr/share/applications/slipstream.desktop
              type: config
          scripts:
            postinstall: scripts/linux/postinstall.sh
          EOF

          # Build packages
          nfpm package -p deb -f nfpm-amd64.yaml -t dist/
          nfpm package -p deb -f nfpm-arm64.yaml -t dist/
          nfpm package -p rpm -f nfpm-amd64.yaml -t dist/
          nfpm package -p rpm -f nfpm-arm64.yaml -t dist/

      - name: Install FUSE (required for AppImage)
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

      - name: Cache appimagetool
        id: cache-appimagetool
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/appimagetool
          key: appimagetool-linux-x86_64-1

      - name: Install appimagetool
        if: steps.cache-appimagetool.outputs.cache-hit != 'true'
        run: |
          curl -L -o /usr/local/bin/appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /usr/local/bin/appimagetool

      - name: Create AppImage
        run: |
          chmod +x scripts/linux/create-appimage.sh
          ./scripts/linux/create-appimage.sh ${{ needs.build-frontend.outputs.version }} amd64

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ needs.build-frontend.outputs.tag }}" \
            dist/*.deb dist/*.rpm dist/*.AppImage --clobber
