name: Release
run-name: "SlipStream ${{ github.ref_name || format('v{0}', inputs.version) }}"

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  GO_VERSION: '1.24'
  BUN_VERSION: 'latest'

jobs:
  # ===========================================
  # Stage 1: Build frontend (shared by all platforms)
  # ===========================================
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install frontend dependencies
        run: bun install --cwd web

      - name: Build frontend
        run: bun run --cwd web build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist
          retention-days: 1

  # ===========================================
  # Stage 2: Platform builds (run in parallel)
  # ===========================================

  # Windows: Native build + WiX v5 MSI installer + portable ZIP
  build-windows:
    needs: build-frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Embed Windows resources
        shell: bash
        run: |
          go install github.com/tc-hib/go-winres@latest
          go-winres make --in scripts/windows/winres.json --out cmd/slipstream/rsrc

      - name: Build Windows binary
        shell: bash
        env:
          CGO_ENABLED: 1
          GOOS: windows
          GOARCH: amd64
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          mkdir -p dist/slipstream_windows_amd64
          go build -ldflags "-s -w -H windowsgui \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${{ steps.version.outputs.version }}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_windows_amd64/slipstream.exe ./cmd/slipstream

      - name: Create portable ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path dist/slipstream_windows_amd64/* -DestinationPath "dist/slipstream_${{ steps.version.outputs.version }}_windows_amd64.zip"

      - name: Install WiX v5
        run: |
          dotnet tool install --global wix
          wix extension add --global WixToolset.UI.wixext
          wix extension add --global WixToolset.Util.wixext

      - name: Create MSI installer
        shell: bash
        run: |
          wix build scripts/windows/installer.wxs \
            -o "dist/slipstream_${{ steps.version.outputs.version }}_windows_amd64.msi" \
            -d VERSION=${{ steps.version.outputs.version }} \
            -bindpath dist=dist/slipstream_windows_amd64 \
            -ext WixToolset.UI.wixext \
            -ext WixToolset.Util.wixext

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist/*.zip
            dist/*.msi
          retention-days: 1

  # macOS Intel (amd64) - native build with CGO for menu bar
  build-macos-amd64:
    if: false # Temporarily disabled - re-enable when ready
    needs: build-frontend
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Build macOS binary (amd64)
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: amd64
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          mkdir -p dist/slipstream_darwin_amd64
          go build -ldflags "-s -w \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${{ steps.version.outputs.version }}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_darwin_amd64/slipstream ./cmd/slipstream

      - name: Create DMG
        run: |
          chmod +x scripts/macos/create-dmg.sh
          ./scripts/macos/create-dmg.sh ${{ steps.version.outputs.version }} amd64

      - name: Upload macOS amd64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-amd64-artifacts
          path: dist/*.dmg
          retention-days: 1

  # macOS Apple Silicon (arm64) - native build with CGO for menu bar
  build-macos-arm64:
    if: false # Temporarily disabled - re-enable when ready
    needs: build-frontend
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Build macOS binary (arm64)
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: arm64
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          mkdir -p dist/slipstream_darwin_arm64
          go build -ldflags "-s -w \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${{ steps.version.outputs.version }}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_darwin_arm64/slipstream ./cmd/slipstream

      - name: Create DMG
        run: |
          chmod +x scripts/macos/create-dmg.sh
          ./scripts/macos/create-dmg.sh ${{ steps.version.outputs.version }} arm64

      - name: Upload macOS arm64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-artifacts
          path: dist/*.dmg
          retention-days: 1

  # Linux: Build binaries + deb/rpm packages + AppImage
  build-linux:
    if: false # Temporarily disabled - re-enable when ready
    needs: build-frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Build Linux binaries
        env:
          CGO_ENABLED: 0
          GOOS: linux
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          mkdir -p dist/slipstream_linux_amd64 dist/slipstream_linux_arm64

          # Build main binary (amd64)
          GOARCH=amd64 go build -ldflags "-s -w \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${{ steps.version.outputs.version }}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_linux_amd64/slipstream ./cmd/slipstream

          # Build main binary (arm64)
          GOARCH=arm64 go build -ldflags "-s -w \
            -X 'github.com/slipstream/slipstream/internal/config.Version=${{ steps.version.outputs.version }}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTMDBKey=${TMDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedTVDBKey=${TVDB_API_KEY}' \
            -X 'github.com/slipstream/slipstream/internal/config.EmbeddedOMDBKey=${OMDB_API_KEY}'" \
            -o dist/slipstream_linux_arm64/slipstream ./cmd/slipstream

          # Build stub launcher (small binary that bootstraps real binary to user dir)
          GOARCH=amd64 go build -ldflags "-s -w" -o dist/slipstream_linux_amd64/slipstream-stub ./cmd/stub
          GOARCH=arm64 go build -ldflags "-s -w" -o dist/slipstream_linux_arm64/slipstream-stub ./cmd/stub

      - name: Create portable tarballs
        run: |
          VERSION=${{ steps.version.outputs.version }}
          # Create tarballs with just the binary (for auto-updates)
          tar -czvf "dist/slipstream_${VERSION}_linux_amd64.tar.gz" -C dist/slipstream_linux_amd64 slipstream
          tar -czvf "dist/slipstream_${VERSION}_linux_arm64.tar.gz" -C dist/slipstream_linux_arm64 slipstream

      - name: Install nfpm
        run: |
          NFPM_VERSION="2.44.1"
          curl -sL "https://github.com/goreleaser/nfpm/releases/download/v${NFPM_VERSION}/nfpm_${NFPM_VERSION}_Linux_x86_64.tar.gz" -o /tmp/nfpm.tar.gz
          tar -xzf /tmp/nfpm.tar.gz -C /tmp
          sudo mv /tmp/nfpm /usr/local/bin/
          nfpm --version

      - name: Create deb/rpm packages
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Create nfpm config for amd64
          # Uses stub launcher pattern: stub in /usr/bin, real binary in /usr/share
          # This enables auto-updates without sudo
          cat > nfpm-amd64.yaml << EOF
          name: slipstream
          arch: amd64
          platform: linux
          version: ${VERSION}
          maintainer: SlipStream <noreply@slipstream.local>
          description: Unified media management system
          vendor: SlipStream
          homepage: https://github.com/jatassi/SlipStream
          license: MIT
          contents:
            - src: dist/slipstream_linux_amd64/slipstream-stub
              dst: /usr/bin/slipstream
            - src: dist/slipstream_linux_amd64/slipstream
              dst: /usr/share/slipstream/slipstream
            - src: scripts/linux/slipstream.service
              dst: /usr/share/doc/slipstream/slipstream.service
              type: config
            - src: scripts/linux/slipstream.desktop
              dst: /usr/share/applications/slipstream.desktop
              type: config
          scripts:
            postinstall: scripts/linux/postinstall.sh
          EOF

          # Create nfpm config for arm64
          cat > nfpm-arm64.yaml << EOF
          name: slipstream
          arch: arm64
          platform: linux
          version: ${VERSION}
          maintainer: SlipStream <noreply@slipstream.local>
          description: Unified media management system
          vendor: SlipStream
          homepage: https://github.com/jatassi/SlipStream
          license: MIT
          contents:
            - src: dist/slipstream_linux_arm64/slipstream-stub
              dst: /usr/bin/slipstream
            - src: dist/slipstream_linux_arm64/slipstream
              dst: /usr/share/slipstream/slipstream
            - src: scripts/linux/slipstream.service
              dst: /usr/share/doc/slipstream/slipstream.service
              type: config
            - src: scripts/linux/slipstream.desktop
              dst: /usr/share/applications/slipstream.desktop
              type: config
          scripts:
            postinstall: scripts/linux/postinstall.sh
          EOF

          # Build packages
          nfpm package -p deb -f nfpm-amd64.yaml -t dist/
          nfpm package -p deb -f nfpm-arm64.yaml -t dist/
          nfpm package -p rpm -f nfpm-amd64.yaml -t dist/
          nfpm package -p rpm -f nfpm-arm64.yaml -t dist/

      - name: Install FUSE (required for AppImage)
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

      - name: Create AppImage
        run: |
          chmod +x scripts/linux/create-appimage.sh
          ./scripts/linux/create-appimage.sh ${{ steps.version.outputs.version }} amd64

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            dist/*.deb
            dist/*.rpm
            dist/*.AppImage
            dist/*.tar.gz
          retention-days: 1

  # ===========================================
  # Stage 3: Collect artifacts and create release
  # ===========================================
  upload-release:
    needs: [build-windows] # Other platforms disabled: build-macos-amd64, build-macos-arm64, build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=v${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "is_dispatch=true" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "is_dispatch=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag for dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git rev-parse ${{ steps.version.outputs.version }} >/dev/null 2>&1; then
            echo "Tag ${{ steps.version.outputs.version }} already exists, skipping creation"
          else
            git tag -a ${{ steps.version.outputs.version }} -m "Release ${{ steps.version.outputs.version }}"
            git push origin ${{ steps.version.outputs.version }}
          fi

      - name: Collect release files
        run: |
          mkdir -p release
          ls -la artifacts/

          # Windows
          cp artifacts/windows-artifacts/*.zip release/ 2>/dev/null || true
          cp artifacts/windows-artifacts/*.msi release/ 2>/dev/null || true

          # macOS
          cp artifacts/macos-amd64-artifacts/*.dmg release/ 2>/dev/null || true
          cp artifacts/macos-arm64-artifacts/*.dmg release/ 2>/dev/null || true

          # Linux
          cp artifacts/linux-artifacts/*.deb release/ 2>/dev/null || true
          cp artifacts/linux-artifacts/*.rpm release/ 2>/dev/null || true
          cp artifacts/linux-artifacts/*.AppImage release/ 2>/dev/null || true

          echo "Release files:"
          ls -la release/

      - name: Upload artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "SlipStream ${{ steps.version.outputs.version }}"
          files: release/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
